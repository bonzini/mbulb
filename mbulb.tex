\documentclass{article}
\usepackage{amsmath}
\usepackage{palatino}
\usepackage{setspace}

\title{To quaternions and back}
\date{\today}
\author{Paolo Bonzini}

\let\vec\mathbf
\def\q#1{\vec#1}

\begin{document}
\maketitle

\setstretch{1.05}

\begin{abstract}
  Daniel White's \emph{Mandelbulb}, with its fractal features on all axes,
  is possibly the closest existing three-dimensional analogue to the 2D
  Mandelbrot set.

  The classic Mandelbrot set is based on the iteration of $z\leftarrow
  z^2+c$ in the complex plane, thus the most common 3D extension
  to the ``Mandelbrot'' set is the iteration of $q\leftarrow q^2+c$
  on quaternions.  The Mandelbulb, instead, is a three-dimensional
  extension of a \emph{geometric} interpretation of complex squaring.

  In this paper, I propose an alternative explanation of the Mandelbulb
  formulas using standard quaternion arithmetic, with the hope of adding
  the necessary mathematical rigor to the discovery of the Mandelbulb.
  A novel quaternion formulation is derived for the Mandelbrot iteration
  formulas; by parameterizing this formula, and appropriately choosing
  the parameters, the various Mandelbulb fractals are produced without
  resorting to non-standard algebras.
\end{abstract}

\section{Introduction}

An extension of the Mandelbrot set to three dimension is a kind of
holy grail for fractalists.  The hurdles are many, because the
bidimensional and three dimensional spaces are inherently very
different: there is no true analogue of the complex field in three
dimensions, that there are no three-dimensional conformal mappings,
the \emph{hairy ball} theorem\dots\ and besides all this, the
expectations for such an object are incredibly high!

There are two main extensions of the Mandelbrot and Julia sets, both
of them to four dimensions.  One is to use quaternions instead of
complex numbers.  In order to reduce four dimensions to three, a
``stack'' of parallel 4D planes is intersected with the object and the
intersecting voxels are plotted.  The resulting objects possess
complexity, but not the infinite level of detail shown by the 2D
Mandelbrot and Julia sets---some of them are basically solids of
revolution, ``lathed'' versions of the 2D Mandelbrot set.

Another 4D expression of the Mandelbrot set does not use quaternions,
but rather composes four coordinates from the two parameters of
the iteration, $z_0$ and $c$.  Then the standard complex iteration
is used.  The 2D slices of this set are very interesting, since
they include both the Mandelbrot set (lying on the $z_0=0$ plane)
and the Julia sets (corresponding to all the constant-$c$ planes).
However, the 3D slices also fail to provide the infinite detail
and sheer beauty of their 2D correspondents.

From 2007 to 2009, Daniel White experimented with a new approach to
the quest, whose resulting fractals he named \emph{Mandelbulbs}.  In
order to understand it, I should digress shortly and explain some
properties of complex numbers.  In addition to using a purely
mathematical description in terms of complex numbers, the Mandelbrot
set's orbits can also be studied geometrically.  The real and
imaginary parts $z=a+ib$ are represented on the 2D plane by using the
real axis as the $x$ axis, and the imaginary as the $y$, and the
arithmetic operations also have a geometric interpretation.

Addition is obvious.  In order to understand multiplication, complex
numbers have to be visualized in a different way using \emph{polar}
coordinates.  The position of a point in a plane is identified by the
distance $\rho$ from the origin, and the angle $\theta$ between the
positive $x$ axis and the point.  This complex number can be written
compactly as $\rho e^{i \theta}$, and the geometric interpretation
of multiplication is derived as follows:
\begin{equation*}
  \rho e^{i \theta} =  \rho_1 e^{i \theta_1} \cdot \rho_2 e^{i \theta_2}
    = \rho_1\rho_2 e^{i (\theta_1 + \theta_2)}
\end{equation*}
  
\noindent
The result of the multiplication $z_1 z_2$ is a point that is obtained
from $z_1$ by \emph{stretching it by a factor $\rho_1$}, and
then \emph{rotating it by an angle $\theta_1$}; and the result of
squaring is obtained by squaring the distance from the origin and
double the angle from the positive $x$ axis.

\section{From 2D to 3D}

Daniel White's intuition then was to invent a meaningful way of squaring
and adding points in 3D space.  To do the former, he had to square
the distance and somehow ``double'' the angle between the positive $x$
axis and the point in exam.  The point is then translated by $c$, and
the two steps are repeated until either the sequence diverges or a given
number of iterations is reached.

Many things in this scheme work out easily.  For example, Euclidean
distance in 3D space is similarly enough to 2D that the divergence
condition is the same: as soon as the distance of $z$ from the origin
exceeds 2, the iteration can be interrupted.  Other things are instead
noticeably different.  For example, it is hard to define the effect of
squaring on angles.  3D space can be described in \emph{spherical
  coordinates} that couple a distance and \emph{two}
angles---corresponding to two rotations around two different axes.
However, rotations in 3D space are \emph{not} commutative.  In fact,
applying White's idea but choosing different angles and axes gives
rise to very different fractals.

On top of this, there is some uneasiness due to the fact that 3D
complex numbers were sought by mathematicians for decades and in the
end they settled for four-component quaternions, despite some strange
properties such as \emph{noncommutative multiplication}.  The infinite
possible ways to define the 3D rotation give the feeling of banging
one's head against dead ends.  Searching for the properties of
three-component numbers whose multiplication is (or seems to be)
commutative, feels too much like a 21st century version of squaring
the circle.

Nevertheless, nothing suggested White's construction to be
fundamentally flawed, and it produced (very) nice pictures, especially
when the $z^2+c$ was tweaked to include higher exponents.  This is a
winning combination for fractalists, who proceeded to experiment
with many different definitions of rotation.  For all of them, the
Mandelbulb iteration with exponent $n$ is then obtained by the
following steps:
\begin{enumerate}
\item \label{item:first-step}
  compute the spherical coordinates $(\rho,\theta,\phi)$ of the
  point $c=(x_c,y_c,z_c)$ being examined\footnote{Unfortunately,
    parenthesized triples may refer throughout the remainder of this
    section to both cartesian and spherical coordinates.  In general,
    the presence of Greek letters such as $\rho$, $\theta$, $\phi$ or
    $\pi$ will mean that a particular occurrence refers to spherical
    coordinates.};

\item \label{item:choice} compute the rotation corresponding to a
  point---remember that complex squaring, by doubling the
  polar-coordinates angle, applies a different rotation for different
  points;

\item \label{item:last-step}
  apply the rotation $n$ times to the point $(\rho^n,0,0)$;
\item translate the result by $c$.
\end{enumerate}

The urge to write this in a form that resembles Julia and Mandelbrot's
$z\leftarrow z^n+c$ is hard to resist, so White defined $z^n$ in 3D space as
applying steps \ref{item:first-step}--~\ref{item:last-step} of the
above procedure.  The actual details of exponentiation of course
depend on the actual rotation chosen for step~\ref{item:choice}.

\section{Experimenting}

White himself tried many choices, but as of today, there are three
main contestants to the title of ``best Mandelbulb rotation''.
Remember that we are defining a rotation whose details depend on the
point being rotated; hence, all three compose a rotation on the $z$ axis
and a rotation on the $y$ axis, parameterizing them by the two angles in
the spherical coordinates of a point---the \emph{azimuth} $\theta$ and
the \emph{elevation} $\phi$.

\begin{equation}
\label{eq:negz}
  R_z(\theta) \cdot R_y(\phi)
\end{equation}
\begin{equation}
\label{eq:posz}
  R_z(\theta) \cdot R_y(-\phi)
\end{equation}
\begin{equation}
\label{eq:cosine}
  R_z(\theta) \cdot R_y(\pi/2-\phi)
\end{equation}

Each of the three has interesting properties, and the first two
degenerate to $R_z(\theta)$ (and hence to the Mandelbrot set) on the
$xy$ plane.  (\ref{eq:negz}) is possibly the most natural solution and
produces a nice exponent-2 Mandelbulb, but it has the apparent
disadvantage that $(x,y,z)^1=(x,y,-z)$.  Instead, (\ref{eq:posz}) has
$(x,y,z)^1=(x,y,z)$.  Even then, (\ref{eq:cosine}) appears to be
much more weird, since $(x,y,z)^0=(0,0,1)$.

Equation~\ref{eq:posz} was discovered by Paul Nylander, who then proceeded to
define a fairly complete algebra with commutative (but nonassociative)
multiplication, multiplicative inverses, and division.  For example,
since
\begin{equation}
  \label{eq:posz-exp}
  (\rho,\theta,\phi)^n=(\rho^n, n\theta, n\phi)
\end{equation}

\noindent
the following definition of multiplication seems natural:
\begin{equation*}
  (\rho_1,\theta_1,\phi_1) (\rho_2,\theta_2,\phi_2)=
  (\rho_1 \rho_2,\theta_1+\theta_2,\phi_1+\phi_2)
\end{equation*}

\noindent
However, this attempt too seemed stuck against a dead end once the
proposed algebra started to show more and more annoying differences
from standard mathematical concepts.  For example, properly
calculating equation~\ref{eq:posz-exp} requires a definition of
$\phi$ in the range $[-\pi,\pi]$, while spherical coordinates define
elevation in the range $[-\pi/2,\pi/2]$.  This in turn means that a
cartesian representation of this algebra is not \emph{power
  associative}\footnote{In a power associative algebra, $(x,y,z)^{n+m}
  \ne (x,y,z)^n (x,y,z)^m$}.

Leaving aside for a moment the nice pictures, the fundamental insight
that White had is this: possibly, the essence of the 2D Mandelbrot does
not rely on the complex field---there could be something else more
fundamental to the set's appearance, and this thing could be rotations.

\section{Reconsidering quaternions}

Now, rotations are something that mathematicians have learnt to handle
very well.  They have two tools of choice to deal with rotations, namely
matrices and\dots\ quaternions.

Matrices are an extremely general tool that can represent arbitrary
linear transformations of an arbitrary vector space, including for
example those that do not preserve angles.  Any of the three equations
in the previous section could indeed be converted to a 3x3 matrix $R$,
and the resulting iteration would have this shape:
\begin{equation*}
  (\rho,\theta,\phi)^n = R(\theta,\phi)^n (\rho^n,0,0)
\end{equation*}

\noindent
Even better, the scaling operation could be included in the transformation
matrix like this:
\begin{equation*}
  (\rho,\theta,\phi)^n = R(\rho,\theta,\phi)^n (1,0,0)
\end{equation*}
\noindent
under the following conditions:
\begin{itemize}
\item $R$ affects areas by a factor of exactly $\rho$: $\det R = \rho^3$
\item $R$ is a combination of scaling and rotation: $R^{-1} = R^T / \rho^2$
\end{itemize}

If these two conditions are imposed, however, the transformation (a
scaling operation followed by a rotation) is more compactly
represented by a quaternion $q$.  \emph{Note that the operation that
  will be performed on the quaternion is \textbf{not} $q\leftarrow
  q^2+c$, so this will still result in a Mandelbulb} rather than the
disappointing quaternion Julia sets.

\emph{Unit quaternions}, that is quaternions whose norm is 1, represent
the space of 3D rotations in a simple way.  For the purpose of this paper,
it will suffice to show how to describe a rotation by a quaternion,
without explaining the theory behind this.  $\vec{v}$ will indicate a
quaternion with a zero scalar part, that is $x\vec{i}+y\vec{j}+z\vec{k}$;
the rotation by an angle $\alpha$ around axis is then represented by the
following quaternion:
\begin{equation*}
q = \cos \frac\alpha2 + \vec{v} \sin \frac\alpha2
\end{equation*}

The rotation is clockwise if the observer's line of sight points in the
same direction as $\vec{v}$.  A rotation $q$ can be applied to a vector
$\vec{w}$ by computing two quaternion multiplications, specifically
$q\vec{v}q^{-1}$.

Rotations can be composed by multiplying two quaternions; ordering is
significant, since quaternion multiplication is noncommutative.  $q^n$
instead is well defined as a rotation by $n$ times the angle around the
same axis as $q$, since multiplication is still associative.

These formulas of course work in 2D too; in this case the rotated
point will be of the form $x\vec{i}+y\vec{j}$ and, in order to stay in
the $xy$ plane, the rotation must be performed around the $z$ axis:
\begin{equation*}
q = \cos \frac\alpha2 + \vec{k} \sin \frac\alpha2
\end{equation*}

\noindent
This is more compactly written $e^{\vec{k}\alpha/2}$.  The polar
representation of complex numbers also has an equivalent using quaternions
on the $xy$ plane, albeit the expression is more complicated.
Let $\vec{v}=x\vec{i}+y\vec{j}$ be a
point on the $xy$ plane, and $(\rho,\theta)$ its polar representation.
Then, it's possible to write $\vec{v}$ from $\rho$ and $\theta$ as follows:
\begin{equation*}
\vec{v}=\rho e^{\vec{k}\theta/2} \vec{i} e^{-\vec{k}\theta/2}
\end{equation*}

From here it is a short step to a somewhat nontraditional formulation of
the Mandelbrot set, based on quaternion rotations.  It was already said
repeatedly that $\vec{v^2}$ corresponds to squaring $\rho$ and doubling
$\theta$.  Then, it's possible to write $\vec{v^2+c}$ as follows:
\begin{equation*}
\vec{v}^2+\vec{c}=\rho^2 e^{\vec{k}\theta} \vec{i} e^{-\vec{k}\theta}+\vec{c}
\end{equation*}

But this can complicated expression can be simplified
noticeably.  For unit quaternions, $q^{-1}=\bar q$:
inversion and conjugation are the same operation, and $q\vec{i}q^{-1}$ can
also be written $q\vec{i}\bar q$.  When the modulus is not one, instead,
$q\vec{i}\bar q = |q|^2 q\vec{i}q^{-1}$.  Therefore we can define
\begin{equation*}
q = \rho e^{i\vec{k}\theta} = x + y\vec{k} = -\vec{v}\vec{i}
\end{equation*}

\noindent
and write:
\begin{equation*}
\vec{v}^2+\vec{c}=q \vec{i} \bar q+\vec{c}
\end{equation*}

\noindent
Changing the sign of $q$ does not modify the effect of the
rotation\footnote{This is true for all quaternions, since quaternions
  are actually a \emph{double cover} of the space of rotations.}, and
it slightly simplifies the iteration.  The iteration formula will then be
the following for the classic Mandelbrot set:
\begin{equation*}
\vec{v}\leftarrow q \vec{i} \bar q+\vec{c}\text{ with }q=\vec{v}\vec{i}.
\end{equation*}

\noindent
and, generalizing the exponent $n$ to values other than $2$:
\begin{equation}
\label{eq:quat}
\vec{v}\leftarrow q^{n/2} \vec{i} \bar q^{n/2}+\vec{c}\text{ with }q=\vec{v}\vec{i}.
\end{equation}

\noindent
The final iteration after substitution and simplification is the following:
\begin{equation*}
\vec{v}\leftarrow\vec{v}^{n/2} \vec{i} \vec{\bar v}^{n/2}+\vec{c}
\end{equation*}

\noindent
This is the \emph{quaternion formulation of the Mandelbrot set}.  However,
when drawn in 3D it results simply in the ``lathed'' 2D Mandelbrot set.
So, for the sake of generalizing to three dimensions (and rediscovering
the Mandelbulb in its quaternion form), we'll have to take a step back
and look at equation~\ref{eq:quat} with 3D eyes.

\section{Rethinking the Mandelbulb}

%% \section{Conclusion}
%% 
%% Who knows?

\end{document}
